#
# Build Botframework-CLI-orchestrator on Windows agent
#

# "name" here defines the build number format. Build number is accessed via $(Build.BuildNumber)
name: $(Build.BuildId)

pool:
  name: Hosted Windows 2019 with VS2019

jobs:
  - job: CLI
    variables:
      buildVersion: '4.9.0-preview.$(Build.BuildId)'
      _version: ${{coalesce(variables.version, variables.buildVersion)}}

    steps:
    - task: colinsalmcorner.colinsalmcorner-buildtasks.tag-build-task.tagBuildOrRelease@0
      displayName: 'Tag Build with version number'
      inputs:
        tags: 'Version=$(_version)'
      continueOnError: true
      condition: and(succeeded(), eq(variables['System.PullRequest.IsFork'], 'False'))

    - task: DownloadBuildArtifacts@0
      displayName: 'Download Artifacts from Orchestrator-.NET-Desktop-signed'
      inputs:
        buildType: specific
        project: '6d527033-e720-40e2-8e39-c804959c6dcd'
        pipeline: 928
        artifactName: drop
        downloadPath: '$(System.ArtifactsDirectory)/orchestrator'

    - powershell: |
       pushd ..
       Get-ChildItem -ErrorAction Continue -Recurse -Force | Where {$_.FullName -notlike "*node_modules*"}
      displayName: 'Dir workspace 1 except node-modules (takes 3 minutes)'
      errorActionPreference: continue
      continueOnError: true
      condition: succeededOrFailed()

    - task: CopyFiles@2
      displayName: 'Copy Orchestrator artifacts to packages/orchestrator/lib/commands/orchestrator/netcoreapp3.1'
      inputs:
        SourceFolder: '$(System.ArtifactsDirectory)/orchestrator/drop'
        Contents: '**'
        TargetFolder: '$(Build.SourcesDirectory)/packages/orchestrator/lib/commands/orchestrator'
        flattenFolders: false
      condition: succeededOrFailed()

    - powershell: |
       pushd ..
       Get-ChildItem -ErrorAction Continue -Recurse -Force | Where {$_.FullName -notlike "*node_modules*"}
      displayName: 'Dir workspace 2 except node-modules (takes 3 minutes)'
      errorActionPreference: continue
      continueOnError: true
      condition: succeededOrFailed()

    - task: NodeTool@0
      displayName: 'Use Node 12.x'
      inputs:
        versionSpec: 12.x

    - task: Npm@1
      displayName: 'Install rush'
      inputs:
        command: custom
        verbose: false
        customCommand: 'install --global @microsoft/rush'

    - powershell: |
       pushd ..
       Get-ChildItem -ErrorAction Continue -Recurse -Force | Where {$_.FullName -notlike "*node_modules*"}
      displayName: 'Dir workspace 3 except node-modules (takes 3 minutes)'
      errorActionPreference: continue
      continueOnError: true
      condition: succeededOrFailed()

    - script: 'rush update'
      displayName: 'rush update'

    - powershell: |
       pushd ..
       Get-ChildItem -ErrorAction Continue -Recurse -Force | Where {$_.FullName -notlike "*node_modules*"}
      displayName: 'Dir workspace 4 except node-modules (takes 3 minutes)'
      errorActionPreference: continue
      continueOnError: true
      condition: succeededOrFailed()

    - script: 'rush build -p 2'
      displayName: 'rush build'

    - powershell: |
       pushd ..
       Get-ChildItem -ErrorAction Continue -Recurse -Force | Where {$_.FullName -notlike "*node_modules*"}
      displayName: 'Dir workspace 5 except node-modules (takes 3 minutes)'
      errorActionPreference: continue
      continueOnError: true
      condition: succeededOrFailed()

    - script: 'rush test -p 2 -v'
      displayName: 'rush test'
      continueOnError: true
      enabled: false
      
    - script: 'rush posttest'
      displayName: 'rush posttest'
      continueOnError: true
      enabled: false

    - script: 'node ./common/scripts/version-and-pack.js --version $(_version)'
      displayName: 'Version and Pack'
      continueOnError: true

    - task: CopyFiles@2
      displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
      inputs:
        SourceFolder: ./.output
        Contents: '**/*.tgz'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'
        flattenFolders: true

    - powershell: |
       pushd ..
       Get-ChildItem -ErrorAction Continue -Recurse -Force | Where {$_.FullName -notlike "*node_modules*"}
      displayName: 'Dir workspace 6 except node-modules (takes 3 minutes)'
      errorActionPreference: continue
      continueOnError: true
      condition: succeededOrFailed()

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        artifactName: 'drop'

    - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
      displayName: 'Component Detection'
      enabled: false

    - script: 'rush report:coverage'
      displayName: 'rush report:coverage'
      enabled: false

    - powershell: |
       pushd ..
       Get-ChildItem -ErrorAction Continue -Recurse -Force | Where {$_.FullName -notlike "*node_modules*"}
      displayName: 'Dir workspace except node-modules (takes 3 minutes)'
      errorActionPreference: continue
      continueOnError: true
      condition: succeededOrFailed()

    - script: 'dir .. -s'
      displayName: 'Dir workspace'
      continueOnError: true
      condition: succeededOrFailed()
      enabled: false